<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CommuMeter</title>

    <script
      href="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.js"
    ></script>
    <!-- <script
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"
    ></script>

    <link rel="stylesheet"
    href=https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css
    /> -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.0.7/css/dataTables.bootstrap5.css"
    />

    <!-- ======= Styles ====== -->
    <link rel="stylesheet" href="./assets/css/style.css" />

    <!-- ======= DataTables ====== -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.0.7/css/dataTables.dataTables.css"
    />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Sweet Alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>

  <style>
    .main {
      flex: 1 0 auto;
      overflow-y: auto;
      padding: 20px;
    }

    .main .tables-content {
      width: 100%;
      max-width: 800px;
      margin: 20px auto; /* Center and provide margin */
      padding: 20px;

      border: 1px solid #ccc;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px; /* rounded corners */
      text-align: center; /* Center text within the box */
      background: #edd2cb; /* Optional: for better contrast */
    }

    .textinput {
      max-width: 100%;
    }
  </style>

  <body>
    <!-- =============== Navigation ================ -->
    <div class="navcontainer">
      <div class="navigation">
        <ul>
          <li>
            <a href="#">
              <span class="icon">
                <ion-icon name="speedometer"></ion-icon>
              </span>
              <span class="title">CommuMeter</span>
            </a>
          </li>

          <li>
            <a href="dashboard.html">
              <span class="icon">
                <ion-icon name="home-outline"></ion-icon>
              </span>
              <span class="title">Dashboard</span>
            </a>
          </li>

          <li>
            <a href="map.html">
              <span class="icon">
                <ion-icon name="map-outline"></ion-icon>
              </span>
              <span class="title">Map</span>
            </a>
          </li>

          <li>
            <a href="barangays.html">
              <span class="icon">
                <ion-icon name="compass-outline"></ion-icon>
              </span>
              <span class="title">Barangays</span>
            </a>
          </li>

          <li>
            <a href="coordinates.html">
              <span class="icon">
                <ion-icon name="locate-outline"></ion-icon>
              </span>
              <span class="title">Coordinates</span>
            </a>
          </li>

          <li>
            <a href="records.html">
              <span class="icon">
                <ion-icon name="server-outline"></ion-icon>
              </span>
              <span class="title">Mobility Data</span>
            </a>
          </li>

          <li>
            <a href="charts.html">
              <span class="icon">
                <ion-icon name="analytics"></ion-icon>
              </span>
              <span class="title">Visualizations</span>
            </a>
          </li>

          <li>
            <a href="#">
              <span class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span class="title" id="logout">Sign Out</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- ========================= Main ==================== -->
      <div class="main">
        <div class="topbar">
          <div class="toggle">
            <ion-icon name="menu-outline"></ion-icon>
          </div>
        </div>

        <!-- ================ Barangays Table ================= -->

        <div class="tables-content">
          <div class="cardHeader">
            <h2>Fare</h2>

            <div class="btn">
              <button class="btn btn-good btn-add" class="icon" id="add">
                <ion-icon
                  name="add-circle"
                  style="padding-right: 5px; text-align: center"
                ></ion-icon
                >Add Fare
              </button>
            </div>
          </div>

          <div class="container-sm" style="max-width: 100%">
            <table id="myTable" style="width: 100%"></table>
          </div>

          <div id="editModal">
            <h3>Edit Record</h3>
            <form id="editForm">
              <div id="origin">Location -</div>
              <input
                class="textinput"
                type="text"
                id="location_edit"
                name="location_edit"
              /><br />
              <div id="destination">Destination -</div>
              <input
                class="textinput"
                type="text"
                id="destination_edit"
                name="destination_edit"
              /><br />
              <label for="fare_edit">Fare:</label>
              <input
                class="textinput"
                type="number"
                id="fare_edit"
                name="fare_edit"
              /><br />
              <div class="btn">
                <input
                  type="button"
                  id="cancelEdit"
                  class="btn btn-bad"
                  value="Cancel"
                />
                <input
                  type="button"
                  id="update"
                  class="btn btn-good"
                  value="Update"
                />
              </div>
            </form>
          </div>

          <div id="addModal">
            <h3>Add Fare</h3>
            <form id="editForm">
              <label for="locationAdd">Location:</label>
              <input
                class="textinput"
                type="text"
                id="locationAdd"
                placeholder="Origin Location"
                name="locationAdd"
                required
              /><br />
              <label for="destinationAdd">Destination:</label>
              <input
                class="textinput"
                type="text"
                id="destinationAdd"
                placeholder="Destination"
                name="destinationAdd"
                required
              />
              <label for="fareAdd">Fare:</label>
              <input
                class="textinput"
                type="text"
                id="fareAdd"
                placeholder="Cost"
                name="fareAdd"
                required
              />
              <div class="btn">
                <input
                  type="button"
                  id="cancelAdd"
                  class="btn btn-bad"
                  value="Cancel"
                />
                <input
                  type="button"
                  id="saveAdd"
                  class="btn btn-good"
                  value="Save"
                />
              </div>
            </form>
          </div>

          <div id="deleteModal">
            <h3>Delete Confirmation</h3>
            <center>
              <p style="padding-bottom: 10px">
                Are you sure you want to delete this record?
              </p>
              <div class="btn">
                <button id="delCancel" class="btn btn-bad">Cancel</button>
                <button id="delConfirm" class="btn btn-good">Confirm</button>
              </div>
            </center>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- =========== Scripts =========  -->
  <script src="assets/js/main.js"></script>

  <!-- ====== ionicons ======= -->
  <script
    type="module"
    src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
  ></script>
  <script
    nomodule
    src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
  ></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut,
    } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      connectFirestoreEmulator,
      query,
      getDocs,
      getDoc,
      updateDoc,
      setDoc,
      doc,
      onSnapshot,
      deleteDoc,
      where,
      orderBy,
    } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYPv8S_ljSo3tuMNoRYPI2tleWOqhqFMM",
      authDomain: "commumeter.firebaseapp.com",
      projectId: "commumeter",
      storageBucket: "commumeter.appspot.com",
      messagingSenderId: "1098693151947",
      appId: "1:1098693151947:web:c0ce3c093e75ae8cbe1f4e",
      measurementId: "G-71SRN52DX4",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    console.log(app);

    const collectionRef = query(collection(db, "fare"));

    let table;

    // Edit Modal
    const editModal = document.getElementById("editModal");

    console.log("editModal:", editModal);
    const editForm = document.getElementById("editForm");
    const originField = document.getElementById("origin");
    const destinationField = document.getElementById("destination");
    const fareEditField = document.getElementById("fare_edit");

    const addModal = document.getElementById("addModal");
    const locationAddField = document.getElementById("locationAdd");
    const destinationAddField = document.getElementById("destinationAdd");
    const fareAddField = document.getElementById("fareAdd");

    //lantawa ang code ani, lahi ra kaayo
    //sa uban CRUD code...

    async function getFareData(docId) {
      try {
        const docRef = doc(db, "fare", docId);
        const docSnapshot = await getDoc(docRef);

        if (docSnapshot.exists()) {
          const data = docSnapshot.data();
          return data;
        } else {
          console.error(`No document found for ID: ${docId}`);
          return null;
        }
      } catch (error) {
        console.error("Error getting document:", error);
      }
    }

    $(".btn-add").on("click", function () {
      // Show the modal
      $("#addModal").show();
    });

    $("#cancelAdd").on("click", function () {
      // Hide the modal
      $("#addModal").hide();
    });

    // Edit Button Click Handler
    function handleEditClick(location, destination, fare) {
      console.log("handleEditClick called with:", location, destination, fare);
      console.log("editModal.classList:", editModal.classList);
      originField.textContent = `Location - ${location}`;
      destinationField.textContent = `Destination - ${destination}`;
      fareEditField.value = fare;

      $("#editModal").show();
    }

    $(".btn-add").on("click", function () {
      // Show the modal
      $("#addModal").show();
    });

    async function addFare(docId, location, destination, fare) {
      try {
        const data = await getFareData(docId);
        if (data) {
          if (!data[location]) {
            //wa ko kasabot ani
            data[location] = {};
          }
          data[location][destination] = fare;

          const docRef = doc(db, "fare", docId);
          await setDoc(docRef, data);

          console.log(`Added fare for ${destination} at ${location}.`);
        }
      } catch (error) {
        console.error("Error adding fare:", error);
      }
    }

    // Save Button Click Handler
    document.getElementById("saveAdd").addEventListener("click", async () => {
      const origin = locationAddField.value;
      const destination = destinationAddField.value;
      const fare = parseFloat(fareAddField.value);
      const docId = "U241ETIba3hshDHC1vlF";
      await addFare(docId, origin, destination, fare);

      // Close the add modal after saving
      $("#addModal").hide();
    });

    // Cancel Edit Button Click Handler
    $("#cancelEdit").on("click", function () {
      // Hide the modal
      $("#editModal").hide();
    });

    // Function to update fare data, including location and destination
    async function updateFare(
      docId,
      oldLocation,
      oldDestination,
      newLocation,
      newDestination,
      newFare
    ) {
      try {
        const data = await getFareData(docId);
        if (
          data &&
          data[oldLocation] &&
          data[oldLocation].hasOwnProperty(oldDestination)
        ) {
          // Delete old entry
          delete data[oldLocation][oldDestination];

          // Add new entry
          if (!data[newLocation]) {
            data[newLocation] = {};
          }
          data[newLocation][newDestination] = newFare;

          const docRef = doc(db, "fare", docId);
          await setDoc(docRef, data);

          console.log(
            `Updated fare for ${newDestination} at ${newLocation} with a fare of ${newFare}`
          );
        } else {
          console.error(
            `Destination '${oldDestination}' not found in location '${oldLocation}'.`
          );
        }
      } catch (error) {
        console.error("Error updating fare:", error);
      }
    }

    // Update Button Click Handler
    document.getElementById("update").addEventListener("click", async () => {
      const newLocation = document.getElementById("location_edit").value;
      const newDestination = document.getElementById("destination_edit").value;
      const newFare = parseFloat(document.getElementById("fare_edit").value);

      const oldLocation = document
        .getElementById("origin")
        .textContent.split(" - ")[1];
      const oldDestination = document
        .getElementById("destination")
        .textContent.split(" - ")[1];

      const docId = "U241ETIba3hshDHC1vlF"; // The document ID containing all fare data

      await updateFare(
        docId,
        oldLocation,
        oldDestination,
        newLocation,
        newDestination,
        newFare
      );

      $("#editModal").hide(); // Close the edit modal
    });

    // Event delegation for handling edit button clicks
    document.querySelector("#myTable").addEventListener("click", (event) => {
      console.log("Edit button clicked");
      if (event.target.classList.contains("btn-edit")) {
        const location = event.target.getAttribute("data-location");
        const destination = event.target.getAttribute("data-destination");
        const fare = event.target.getAttribute("data-fare");
        handleEditClick(location, destination, fare);
      }
    });

    let location;
    let destination;
    let fare;

    onSnapshot(collectionRef, (snapshot) => {
      const dataset = [];

      snapshot.forEach((doc) => {
        const data = doc.data();

        console.log(data);

        Object.entries(data).forEach(([location, fares]) => {
          Object.entries(fares).forEach(([destination, fare]) => {
            dataset.push([
              location,
              destination,
              fare,
              `<center><button type="button" class="btn btn-good btn-edit" data-location="${location}"data-destination="${destination}"data-fare="${fare}" style="margin-right: 7px !important;">Edit</button><button type="button" class="btn btn-bad btn-delete"data-location="${location}"data-destination="${destination}"data-fare="${fare}">Delete</button></center>`,
            ]);
          });
        });
      });

      if (table) {
        table.destroy();
      }

      table = new DataTable("#myTable", {
        columns: [
          { title: "Location" },
          { title: "Destination" },
          { title: "Fare" },
          { title: "Action" },
        ],
        data: dataset,

        paging: true,
        lengthMenu: [15, 25, 50, 100],
        searching: true,
        stateSave: true,
        scrollX: true,
        responsive: true,
      });
    });

    $("#delCancel").on("click", function () {
      // Hide the modal
      $("#deleteModal").hide();
    });

    // Delete Button Click Handler
    $(document).on("click", ".btn-delete", function () {
      const location = $(this).data("location");
      const destination = $(this).data("destination");
      const fare = $(this).data("fare");

      // Show the delete modal
      $("#deleteModal").show();

      // Set the delete modal data
      $("#deleteModal").data("location", location);
      $("#deleteModal").data("destination", destination);
      $("#deleteModal").data("fare", fare);

      console.log(destination);
      console.log(location);
      console.log(fare);
    });

    // Function to delete a fare entry
    async function deleteFare(docId, location, destination) {
      try {
        const docRef = doc(db, "fare", docId);
        const docSnapshot = await getDoc(docRef);

        if (docSnapshot.exists()) {
          const data = docSnapshot.data();

          if (data[location] && data[location].hasOwnProperty(destination)) {
            const nestedMap = data[location];
            delete nestedMap[destination];

            await updateDoc(docRef, { [location]: nestedMap });
            console.log(
              `Deleted destination '${destination}' from location '${location}'.`
            );
          } else {
            console.error(
              `Destination '${destination}' not found in location '${location}'.`
            );
          }
        } else {
          console.error(`No document found for ID: ${docId}`);
        }
      } catch (error) {
        console.error("Error deleting document:", error);
      }
    }

    // Confirm Delete Button Click Handler
    document
      .getElementById("delConfirm")
      .addEventListener("click", async () => {
        try {
          const location = $("#deleteModal").data("location");
          const destination = $("#deleteModal").data("destination");
          const docId = "U241ETIba3hshDHC1vlF"; // The document ID containing all fare data

          await deleteFare(docId, location, destination);

          // Close the delete modal after deleting
          $("#deleteModal").hide();
        } catch (error) {
          console.error(error);
        }
      });
  </script>

  <script src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
  <script src="https://cdn.datatables.net/2.0.7/js/dataTables.bootstrap5.js"></script>
</html>
