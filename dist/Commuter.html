<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iJeep</title>
    <!-- ======= Styles ====== -->
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script src="./assets/js/north-baranggay.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <style>
      #map {
        height: 665px;
        width: 100%;
      }

      .info {
        padding: 6px 8px;
        font: 14px/16px Arial, Helvetica, sans-serif;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
      }
      .info h4 {
        margin: 0 0 5px;
        color: #777;
      }

      .legend {
        line-height: 18px;
        color: #555;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
    </style>
  </head>

  <body>
    <!-- =============== Navigation ================ -->
    <div class="navcontainer">
      <div class="navigation">
        <ul>
          <li>
            <a href="#">
              <span class="icon">
                <ion-icon name="bus"></ion-icon>
              </span>
              <span class="title">iJeep</span>
            </a>
          </li>

          <li>
            <a href="dashboard.html">
              <span class="icon">
                <ion-icon name="home-outline"></ion-icon>
              </span>
              <span class="title">Dashboard</span>
            </a>
          </li>

          <li>
            <a href="map.html">
              <span class="icon">
                <ion-icon name="map-outline"></ion-icon>
              </span>
              <span class="title">Map</span>
            </a>
          </li>

          <li>
            <a href="records.html">
              <span class="icon">
                <ion-icon name="server-outline"></ion-icon>
              </span>
              <span class="title">Mobility Data</span>
            </a>
          </li>

          <li>
            <a href="charts.html">
              <span class="icon">
                <ion-icon name="analytics"></ion-icon>
              </span>
              <span class="title">Visualizations</span>
            </a>
          </li>

          <li>
            <a href="#">
              <span class="icon">
                <ion-icon name="log-out-outline"></ion-icon>
              </span>
              <span class="title" id="logout">Sign Out</span>
            </a>
          </li>
        </ul>
      </div>

      <!-- ========================= Main ==================== -->
      <div class="main">
        <div class="topbar">
          <div class="toggle">
            <ion-icon name="menu-outline"></ion-icon>
          </div>
        </div>
        <div
          class="d-flex justify-content-between align-items-center px-3 px-md-5"
        >
          <h2 class="mb-0">MAP</h2>
          <div class="d-flex flex-row align-items-center">
            <button id="showCoordsBtn" type="button" class="btn btn-info me-3">
              Add Location
            </button>
            <select id="routeFilter" class="form-select">
              <option value="all">Filter Route</option>
              <option value="Dalipuga">Dalipuga</option>
              <option value="Luinab">Luinab</option>
              <option value="Tambo">Tambo</option>
              <option value="Santiago">Santiago</option>
            </select>
          </div>
        </div>

        <!-- =============== MAP ============= -->
        <div id="map">
          <div class="leaflet-bottom leaflet-left p-3 bg-white shadow">
            <h4>Legend</h4>
            <div class="row">
              <div class="col-auto">
                <img
                  src="assets/img/yellowmarker.png"
                  alt="Marker"
                  style="width: 20px; height: 20px"
                />
              </div>
              <div class="col">Route 1</div>
            </div>
            <div class="row">
              <div class="col-auto">
                <img
                  src="assets/img/redmarker.png"
                  alt="Marker"
                  style="width: 20px; height: 20px"
                />
              </div>
              <div class="col">Route 2</div>
            </div>
            <div class="row">
              <div class="col-auto">
                <img
                  src="assets/img/tealmarker.png"
                  alt="Marker"
                  style="width: 20px; height: 20px"
                />
              </div>
              <div class="col">Route 3</div>
            </div>
            <!-- Add more routes as needed -->
          </div>
        </div>
      </div>
      <!-- Button to Open Modal -->

      <div
        class="modal fade"
        id="latLngModal"
        tabindex="-1"
        aria-labelledby="modalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel">Location Coordinates</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body">
              <p id="latLngText">Latitude: 0, Longitude: 0</p>
              <div id="fareDisplay">Fare:</div>
              <div class="mb-3">
                <label for="routeSelect" class="form-label"
                  >Select a Route:</label
                >
                <select class="form-select" id="routeSelect">
                  <option selected>Dalipuga</option>
                </select>
                <label for="commuterlocation" class="form-label"
                  >Select your Location:</label
                >
                <select class="form-select" id="commuterlocation">
                  <option value="City Proper">City Proper</option>
                  <option value="MSU-IIT">MSU-IIT</option>
                  <option value="Traffic Light Tambo">
                    Traffic Light Tambo
                  </option>
                  <option value="Tambo Gerona">Tambo Gerona</option>
                  <option value="Barinaut High Way">Barinaut High Way</option>
                  <option value="Valderama">Valderama</option>
                  <option value="St. Felomina">St. Felomina</option>
                  <option value="Acmac Brgy. Hall">Acmac Brgy. Hall</option>
                  <option value="Purok 7 Kiwalan">Kiwalan</option>
                  <option value="Pilmico">Pilmico</option>
                  <option value="Tagibo">Tagibo</option>
                  <option value="Dalipuga Crossing Kalubihon">
                    Dalipuga Crossing Kalubihon
                  </option>
                  <option value="Dalipuga Proper">Dalipuga Proper</option>
                  <option value="Paitan">Paitan</option>
                  <option value="Mapalad">Mapalad</option>
                  <option value="Boundary Lugait/Iligan">
                    Boundary Lugait/Iligan
                  </option>
                </select>
                <label for="routeto" class="form-label">To:</label>
                <select class="form-select" id="routeto">
                  <option selected>Select Destination</option>
                  <option value="City Proper">City Proper</option>
                  <option value="MSU-IIT">MSU-IIT</option>
                  <option value="Traffic Light Tambo">
                    Traffic Light Tambo
                  </option>
                  <option value="Tambo Gerona">Tambo Gerona</option>
                  <option value="Barinaut High Way">Barinaut High Way</option>
                  <option value="Valderama">Valderama</option>
                  <option value="St. Felomina">St. Felomina</option>
                  <option value="Acmac Brgy. Hall">Acmac Brgy. Hall</option>
                  <option value="Purok 7 Kiwalan">Kiwalan</option>
                  <option value="Pilmico">Pilmico</option>
                  <option value="Tagibo">Tagibo</option>
                  <option value="Dalipuga Crossing Kalubihon">
                    Dalipuga Crossing Kalubihon
                  </option>
                  <option value="Dalipuga Proper">Dalipuga Proper</option>
                  <option value="Paitan">Paitan</option>
                  <option value="Mapalad">Mapalad</option>
                  <option value="Boundary Lugait/Iligan">
                    Boundary Lugait/Iligan
                  </option>

                  <!-- Add more options based on your routes -->
                </select>
                <label for="howmany" class="form-label"
                  >How many Commuters?</label
                >
                <input
                  type="number"
                  id="howmany"
                  class="form-control"
                  min="1"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button
                type="button"
                class="btn btn-primary"
                id="confirmSelectionBtn"
              >
                Confirm Selection
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script type="module">
      // Define global variables to store the last clicked latitude and longitude
      var lastClickedLat;
      var lastClickedLng;
      // access map variables to alll other functions
      var map;

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        connectFirestoreEmulator,
        query,
        getDocs,
        getDoc,
        updateDoc,
        setDoc,
        doc,
        where,
        onSnapshot,
        deleteDoc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDYPv8S_ljSo3tuMNoRYPI2tleWOqhqFMM",
        authDomain: "commumeter.firebaseapp.com",
        projectId: "commumeter",
        storageBucket: "commumeter.appspot.com",
        messagingSenderId: "1098693151947",
        appId: "1:1098693151947:web:c0ce3c093e75ae8cbe1f4e",
        measurementId: "G-71SRN52DX4",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Load map after page is ready
      document.addEventListener("DOMContentLoaded", function () {
        map = L.map("map").setView([8.231, 124.240967], 13);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "© OpenStreetMap contributors",
        }).addTo(map);

        // Function to capture and store map click coordinates
        function onMapClick(e) {
          lastClickedLat = e.latlng.lat.toFixed(5); // Adjust the precision as needed
          lastClickedLng = e.latlng.lng.toFixed(5);

          console.log(e.latlng);

          // Remove previous markers if they exist in the map
          if (window.lastMarker) {
            map.removeLayer(window.lastMarker);
          }

          // Create a new marker at the clicked location
          var marker = L.marker(e.latlng).addTo(map);

          // Save the marker to the window object to remove it later
          window.lastMarker = marker;

          // Attach a popup to the marker displaying the latitude and longitude
          marker
            .bindPopup(
              "Latitude: " + lastClickedLat + "<br>Longitude: " + lastClickedLng
            )
            .openPopup();
        }

        // when map is clicked, a marker is shown in the map
        map.on("click", onMapClick);

        // Function to display the modal with the stored coordinates
        function showModalWithCoords() {
          // Check if coordinates are available
          if (lastClickedLat !== undefined && lastClickedLng !== undefined) {
            // Get the selected route
            const selectedRoute = document.getElementById("routeSelect").value;

            // Update the modal content
            document.getElementById("latLngText").innerHTML =
              "Latitude: " + lastClickedLat + ", Longitude: " + lastClickedLng;

            // Show the modal
            var modal = new bootstrap.Modal(
              document.getElementById("latLngModal")
            );
            modal.show();
          } else {
            alert("Please click on the map to select a location first.");
          }
        }

        // Attach the showModalWithCoords function to the button's click event
        document
          .getElementById("showCoordsBtn")
          .addEventListener("click", function () {
            showModalWithCoords();
          });
      });

      // calculate the fare of commuters

      // ensure that a user is logged in before they can interact with the website
      // if not, redirect them to the login page
      // also store "user" object that will be used later for retrieving user data
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log(user.uid);
        } else {
          window.location.href = "logincommuter.html"; // Change "/login" to your login route
        }

        //signout function
        document
          .getElementById("logout")
          .addEventListener("click", function () {
            signOut(auth)
              .then(() => {
                // Sign-out successful.
                console.log("Sign-out successful.");
                alert("Sign-out successful.");
                window.location.href = "index.html";
              })
              .catch((error) => {
                // An error happened.
                console.log("An error happened.");
              });
          });

        // Icons
        const redIcon = new L.Icon({
          iconUrl: "assets/img/redmarker.png",
          iconSize: [37, 41],
          iconAnchor: [18, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowUrl: "assets/img/shadowmarker.png",
          shadowSize: [41, 41],
          shadowAnchor: [13, 41],
        });

        const tealIcon = new L.Icon({
          iconUrl: "assets/img/tealmarker.png",
          iconSize: [37, 41],
          iconAnchor: [18, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowUrl: "assets/img/shadowmarker.png",
          shadowSize: [41, 41],
          shadowAnchor: [13, 41],
        });

        const greenIcon = new L.Icon({
          iconUrl: "assets/img/greenmarker.png",
          iconSize: [37, 41],
          iconAnchor: [18, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowUrl: "assets/img/shadowmarker.png",
          shadowSize: [41, 41],
          shadowAnchor: [13, 41],
        });

        const yellowIcon = new L.Icon({
          iconUrl: "assets/img/yellowmarker.png",
          iconSize: [37, 41],
          iconAnchor: [18, 41],
          popupAnchor: [1, -34],
          tooltipAnchor: [16, -28],
          shadowUrl: "assets/img/shadowmarker.png",
          shadowSize: [41, 41],
          shadowAnchor: [13, 41],
        });

        // Function to get the appropriate icon based on the route
        // Can add more icons and routes if necessary
        function getIconForRoute(route) {
          switch (route) {
            case "Tambo":
              return redIcon;
            case "Dalipuga":
              return tealIcon;
            case "Luinab":
              return greenIcon;
            case "Santiago":
              return yellowIcon;
            default:
              return L.Icon.Default; // Default icon
          }
        }

        let selectedRoute = "all";

        // Function to filter and display markers
        async function filterMarker() {
          const q = query(
            collection(db, "commutermark"),
            where("userId", "==", user.uid)
          );
          const querySnapshot = await getDocs(q);
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.display == true) {
              if (selectedRoute === "all" || data.route === selectedRoute) {
                const marker = L.marker([data.latitude, data.longitude], {
                  icon: getIconForRoute(data.route),
                }).addTo(map);
                marker.bindPopup(
                  `Route: ${data.route}<br>Destination: ${data.to}`
                );
              }
            }
          });
        }

        // filterMarker(user.uid);

        //when clicked, reflect the changes to the map based on the selected route
        document
          .getElementById("routeFilter")
          .addEventListener("change", function () {
            selectedRoute = this.value;
            map.eachLayer(function (layer) {
              if (layer instanceof L.Marker) {
                map.removeLayer(layer);
              }
            });
            filterMarker();
          });

        // Real-time listener for changes to the "commutermark" collection
        // based on user.uid
        function setupRealtimeListener() {
          const collectionRef = query(
            collection(db, "commutermark"),
            where("userId", "==", user.uid)
          );
          const markers = {};

          onSnapshot(collectionRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
              const data = change.doc.data();
              const id = change.doc.id;

              if (change.type === "added" || change.type === "modified") {
                if (data.display == true) {
                  // Remove the previous marker if it exists
                  if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                  }

                  // Add the updated marker to the map
                  const marker = L.marker([data.latitude, data.longitude], {
                    icon: getIconForRoute(data.route),
                  }).addTo(map);
                  marker.bindPopup(
                    `Route: ${data.route}<br>Destination: ${data.to}<br>Number of Commuters: ${data.howmany}`
                  );
                  markers[id] = marker;
                } else {
                  // If the display is false, remove the marker from the map
                  if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                  }
                }
              } else if (change.type === "removed") {
                // Remove the marker from the map when the document is removed
                if (markers[id]) {
                  map.removeLayer(markers[id]);
                  delete markers[id];
                }
              }
            });
          });
        }

        // Call the setupRealtimeListener function to start listening for real-time updates
        setupRealtimeListener();

        //
        //
        //Removed because of cloud functions
        //
        //

        // async function updateOldDocuments() {
        //   const currentTime = Date.now();
        //   const thirtyMinutesAgo = currentTime - 30 * 60 * 1000;

        //   const q = query(
        //     collection(db, "commutermark"),
        //     where("date", "<", new Date(thirtyMinutesAgo)),
        //     where("userId", "==", user.uid)
        //   );
        //   const querySnapshot = await getDocs(q);

        //   const updatePromises = querySnapshot.docs.map((doc) =>
        //     updateDoc(doc.ref, { display: false })
        //   );
        //   await Promise.all(updatePromises);
        // }

        // setInterval(updateOldDocuments, 30 * 60 * 1000);

        //update button text content if mark already exists
        document
          .getElementById("latLngModal")
          .addEventListener("show.bs.modal", async function () {
            const userId = user.uid; // Ensure you have the user's UID available
            const markExists = await checkIfMarkExists(userId);
            const button = document.getElementById("confirmSelectionBtn");
            button.textContent = markExists
              ? "Update Selection"
              : "Confirm Selection";
          });

        //open bootstrap modal dialog
        document
          .getElementById("confirmSelectionBtn")
          .addEventListener("click", async function () {
            var selectedRoute = document.getElementById("routeSelect").value;
            var selectedto = document.getElementById("routeto").value;
            var howmany = document.getElementById("howmany").value;
            console.log("Selected Route:", selectedRoute);
            console.log("How many commuters in the area: ", howmany);

            // Check if a mark already exists for the user
            const markExists = await checkIfMarkExists(user.uid);

            if (markExists) {
              // Update the existing marker to the new location
              updateMarkInFirebase(
                lastClickedLat,
                lastClickedLng,
                selectedRoute,
                selectedto,
                user.uid,
                howmany
              );
            } else {
              // Save data to Firebase as before
              saveDataToFirebase(
                lastClickedLat,
                lastClickedLng,
                selectedRoute,
                selectedto,
                user.uid,
                howmany
              );
            }

            // close the modal programmatically after selection
            var modalEl = document.getElementById("latLngModal");
            var modalInstance = bootstrap.Modal.getInstance(modalEl);
            modalInstance.hide();
          });

        // check if the user already has a marker, if yes, set the button
        // confirm selection to update selection
        async function checkIfMarkExists(userId) {
          const querySnapshot = await getDocs(
            query(collection(db, "commutermark"), where("userId", "==", userId))
          );
          return !querySnapshot.empty;
        }
        // Function to save data to Firebase
        async function saveDataToFirebase(
          lat,
          lng,
          route,
          to,
          userId,
          howmany
        ) {
          try {
            const docRef = await addDoc(collection(db, "commutermark"), {
              userId: userId, // Include the userId in the document
              latitude: lat,
              longitude: lng,
              route: route,
              to: to,
              // howmany: parseInt(howmany),
              date: new Date(),
              display: true,
            });

            // Display success message
            alert("Coordinates and route saved successfully!");
          } catch (error) {
            console.error("Error adding document: ", error);
            alert("An error occurred while saving coordinates and route.");
          }
        }

        // update the marker if marker already exists
        async function updateMarkInFirebase(
          lat,
          lng,
          route,
          to,
          userId,
          howmany
        ) {
          console.log("Updating marker for user:", userId);
          const querySnapshot = await getDocs(
            query(collection(db, "commutermark"), where("userId", "==", userId))
          );
          querySnapshot.forEach(async (doc) => {
            try {
              await updateDoc(doc.ref, {
                latitude: lat,
                longitude: lng,
                route: route,
                to: to,
                howmany: parseInt(howmany),
                date: new Date(),
              });
              alert("Marker updated successfully!");
            } catch (error) {
              console.error("Error updating document: ", error);
              alert("An error occurred while updating the marker.");
            }
          });
        }
      });
    </script>

    <script>
      // Attach event listener to the "Confirm Selection" button
    </script>
    <!-- =========== Scripts =========  -->
    <script src="assets/js/main.js"></script>
    <!-- <script src="assets/js/fare.js"></script> -->
    <script src="assets/js/test.js"></script>
    <!-- ====== ionicons ======= -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
